name: Bidirectional GitHub â†” GitLab Sync

on:
  workflow_dispatch:       # Manual trigger
  schedule:
    - cron: '0 * * * *'     # Hourly sync

permissions:
  contents: write           # Needed to push to GitHub

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Configure Git identity
      run: |
        git config --global user.name "${{ secrets.GIT_USER_NAME }}"
        git config --global user.email "${{ secrets.GIT_USER_EMAIL }}"

    - name: Clone GitHub repo (bare)
      run: |
        git clone --bare "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" repo.git

    - name: Add GitLab remote and fetch
      run: |
        cd repo.git
        git remote add gitlab "${{ secrets.GITLAB_REPO_URL }}"
        git fetch --all

    - name: Pull GitLab changes into GitHub mirror
      run: |
        cd repo.git
        for branch in $(git for-each-ref --format='%(refname:short)' refs/remotes/gitlab/); do
          git branch -f "$branch" "gitlab/$branch" || true
        done
        git push origin --all
        git push origin --tags

    - name: Pull GitHub changes into GitLab mirror
      run: |
        cd repo.git
        for branch in $(git for-each-ref --format='%(refname:short)' refs/remotes/origin/); do
          git branch -f "$branch" "origin/$branch" || true
        done
        git push gitlab --all
        git push gitlab --tags
